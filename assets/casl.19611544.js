var m=Object.defineProperty;var l=Object.getOwnPropertySymbols;var v=Object.prototype.hasOwnProperty,w=Object.prototype.propertyIsEnumerable;var d=(e,i,r)=>i in e?m(e,i,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[i]=r,p=(e,i)=>{for(var r in i||(i={}))v.call(i,r)&&d(e,r,i[r]);if(l)for(var r of l(i))w.call(i,r)&&d(e,r,i[r]);return e};import{l as q,m as I,r as P,i as S,f as R,z as F,n as y,q as a}from"./index.ce29a6e3.js";function L(e){if(e.hasOwnProperty("possibleRulesFor"))return e;var i=P(!0);e.on("updated",function(){i.value=!i.value});var r=e.possibleRulesFor.bind(e);return e.possibleRulesFor=function(n,t){return i.value=i.value,r(n,t)},e.can=e.can.bind(e),e.cannot=e.cannot.bind(e),e}var b=Symbol("ability");function E(){var e=S(b);if(!e)throw new Error("Cannot inject Ability instance because it was not provided");return e}function j(e){return"a"in e?"a":"this"in e?"this":"an"in e?"an":""}q({name:"Can",props:{I:String,do:String,a:[String,Function],an:[String,Function],this:[String,Function,Object],on:[String,Function,Object],not:Boolean,passThrough:Boolean,field:String},setup:function(i,r){var n=r.slots,t=i,o="do",s="on";if(o in i||(o="I",s=j(i)),!t[o])throw new Error("Neither `I` nor `do` prop was passed in <Can>");if(!n.default)throw new Error("Expects to receive default slot");var c=E();return function(){var f=c.can(t[o],t[s],t.field),u=i.not?!f:f;return i.passThrough?n.default({allowed:u,ability:c}):u?n.default():null}}});function A(e,i,r){if(!i||!(i instanceof I))throw new Error("Please provide an Ability instance to abilitiesPlugin plugin");e.provide(b,L(i)),r&&r.useGlobalProperties&&(e.config.globalProperties.$ability=i,e.config.globalProperties.$can=i.can.bind(i))}const N=e=>e.matched.some(i=>y.can(i.meta.action||"read",i.meta.resource));var V=R(({app:e,router:i})=>{e.config.globalProperties.$subject=F,e.use(A,y,{useGlobalProperties:!0}),i.beforeEach(async(r,n,t)=>{const o=await a.isUserLoggedIn(),s=Object.assign({},r.query);if(o||a.logout(),s.office_id&&(a.setOfficeLocation({rid:s.office_id}),s.qr&&a.setCheckIn(!0)),n.fullPath==="/"&&!n.name&&o&&await a.reloadUserInfo({reAuthenticate:!0}),!N(r)){const h=r.path!=="/";return t(o?{name:"not-authorized"}:{name:"login",query:p({},h&&{redirect:r.path})})}if(r.meta.redirectIfLoggedIn&&o)return t("/");const c=await a.phoneNumberVerifyRequired(),f=await a.employeeLinkRequired(),u=await a.getUserFromStore(),g=await a.getSocialRequired();if(c)return n.name==="code-confirmation"&&o&&r.query.code?(await a.setPhoneNumberVerified(!0),t({path:"/"})):r.name!=="code-confirmation"?t({name:"code-confirmation",query:{p:u[9]?u[9].phoneNumber:u[8].replace(/[^0-9]/g,""),rid:u[3]}}):t();if(f||g)return n.name==="verify-identity"&&o&&r.query.verify?(r.query.rid?await a.setIdentityVerified(r.query.rid):await a.setIdentityVerified(!1),t({path:"/",query:{}})):r.name!=="verify-identity"?t({name:"verify-identity",query:{rid:u[3]}}):t();if(r.name==="verify-identity"){if(!f)return t({path:"/"})}else if(r.name==="code-confirmation")return!o&&r.query.ac?t():t({path:"/"});return t()}),i.afterEach(async(r,n)=>{const t=await a.isUserLoggedIn();n.fullPath==="/"&&!n.name&&t&&await a.updateStore({reAuthenticate:!1})})});export{V as default};
